---
title: "Expected credit loss - explanatory data analysis"
author: "Eligijus Bujokas"
date: "12/19/2020"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(ggplot2)
library(zoo)
library(stringr)
Sys.setlocale("LC_ALL","C")
```

# Overview

This document is used to explore the data of the company called "LendingClub". It is an American company that provides short term loans both for individuals and for bussineses. 

To know more about the company, visit: https://www.lendingclub.com/ 

All the files and codes used in this project are stored in the repo: https://github.com/Eligijus112/expected-credit-loss 

The data can be found in kaggle: https://www.kaggle.com/denychaen/lending-club-loans-rejects-data

The data has information about all approved loans from 2007 up until 2019 3th quarter. 

# Reading the data 

```{r "Reading data"}
# Using fread to read the data
d <- fread('data/appl_accepted_20072019Q3.csv')

# Total number of loans in the data set
print(nrow(d))

# Total number of columns 
print(ncol(d))
```

In the dataset there are 150 features regarding a unique loan. We will analyze and use in models only some of the features:

**addr_state** - The state provided by the borrower in the loan application

**annual_inc** - The self-reported annual income provided by the borrower during registration.

**dti** - debt to income ratio; a ratio calculated using the borrower’s total monthly debt payments on the total debt obligations, excluding mortgage and the requested LC loan, divided by the borrower’s self-reported monthly income.

**emp_length** - Employment length in years. Possible values are between 0 and 10 where 0 means less than one year and 10 means ten or more years. 

**earliest_cr_line** - the month at which the earliest credit line was opened for the borrower.

**funded_amnt** - The total amount committed to that loan at that point in time.

**home_ownership** - The home ownership status provided by the borrower during registration or obtained from the credit report. Our values are: RENT, OWN, MORTGAGE, OTHER.

**loan_amnt** - The listed amount of the loan applied for by the borrower. If at some point in time, the credit department reduces the loan amount, then it will be reflected in this value.

**loan_status** - current status of the loan.

**pub_rec** - Number of derogatory public records.

**pub_rec_bankruptcies** - Number of public record bankruptcies

**purpose** - A category provided by the borrower for the loan request. 

**issue_d** - The date at which the loan was issued.

**term** - number of payments on the loan. Values can be either 36 or 60.

**int_rate** - interest rate on the loan.

**recoveries** - post charge off gross recovery.

**total_rec_prncp** - principal received to date.

```{r "Important columns"}
# Defining all the columns used in the analysis
cols_to_use = c(
  "addr_state",
  "annual_inc",
  'emp_length',
  'earliest_cr_line',
  'funded_amnt',
  'home_ownership',
  'loan_amnt',
  'loan_status',
  'pub_rec',
  'pub_rec_bankruptcies',
  'purpose',
  'issue_d',
  'term',
  'int_rate',
  'recoveries',
  'total_rec_prncp'
)

# Subseting the data
d <- d[, ..cols_to_use]

# Printing the top of the data table
head(d)
```
# Data cleaning and engineering

Before analyzing the various splits of the data there are some columns that need to be cleaned and engineered. 

## Creating the Y variable 

```{r y variable}
# Printing out unique loan statuses
print(unique(d$loan_status))

# Function to encode the good loans as 1 and 0 as bad loans
create_Y <- function(x, bad_loans=c('Late (31-120 days)', "Charged Off", "Does not meet the credit policy. Status:Charged Off")){
  return(ifelse(is.element(x, bad_loans), 0, 1))
}

# Creating the Y variable
d[, Y:=create_Y(loan_status)]

# Saving the variable as factor
d$Y <- as.factor(d$Y)

# Visualizing the di stribution of Y 
grouped <- d[, .N, by="Y"]

# Calculating the shares
grouped[, share:=(N/sum(N))]
ggplot(data=grouped, aes(x=Y, y=share)) + geom_bar(stat="identity", fill="steelblue")
```

## Date columns
```{r cleaning:dates}
# Creating the splited columns 
d[, c("issue_m", "issue_y"):=tstrsplit(issue_d, "-")]

# Getting the last two digits of issue_y
d[, issue_y:=str_sub(issue_y, -2)]

# Creating the formated column
d[, issue_d_formated:=zoo::as.yearmon(paste(issue_m, issue_y, sep="-"), "%b-%y")]

# Creating the splited columns 
d[, c("cr_m", "cr_y"):=tstrsplit(earliest_cr_line, "-")]

# Getting the last two digits of issue_y
d[, cr_y:=str_sub(cr_y, -2)]

# Creating the formated column
d[, earliest_cr_line_formated:=zoo::as.yearmon(paste(cr_m, cr_y, sep="-"), "%b-%y")]

# Calculating the difference between the two dates
d[, day_diff:=difftime(issue_d_formated, earliest_cr_line_formated, units='days')]

# Converting to numeric
d[, day_diff:=as.numeric(day_diff)]

# Dropping negative or missing values from the dataframe; these are very old accounts and compise a fraction of percent of the whole data
d <- d[d$day_diff > 0 & !is.na(d$day_diff)]

# Calculating the month diff 
d[, month_diff:=round(day_diff/30)]

# Seeing the difference in densities
ggplot(data=d, aes(x=month_diff, group=Y, fill=Y)) + geom_density(alpha=0.5)
```

## Annual income

```{r annual income}
ggplot(data=d[annual_inc < 200000], aes(x=annual_inc, fill=Y)) + geom_density(alpha=0.5)
```
## Loan amount

```{r loan amount}
ggplot(data=d, aes(x=loan_amnt, fill=Y)) + geom_density(alpha=0.5)
```
## Interest rate 

```{r interest rate}
d$int_rate <- as.numeric(gsub("%", "", d$int_rate))

ggplot(data=d, aes(x=int_rate, fill=Y)) + geom_density(alpha=0.5)
```
## Length of employment

```{r employment length cleaning}
# Function to fill missing values
employment_length_fill <- function(x){
  return(ifelse(is.na(x) | x == "", "< 1 year", x))
}

d[, emp_length:=employment_length_fill(emp_length)]

# Ploting the distribution of loans by emp length
grouped <- d[, .N, by="emp_length"]

# Calculating the shares
grouped[, share:=(N/sum(N))]
ggplot(data=grouped, aes(x=emp_length, y=share)) + geom_bar(stat="identity", fill="steelblue")
```

## Loan term distribution

```{r loan term}
grouped <- d[, .N, by="term"]
grouped[, share:=(N/sum(N))]
ggplot(data=grouped, aes(x=term, y=share)) + geom_bar(stat="identity", fill="steelblue")
```

## LGD independant variable - recovery rate

```{r recovery rate}
d[, recovery_rate:=recoveries/funded_amnt]
d[, recovery_rate:=ifelse(recovery_rate>1, 1, recovery_rate)]

# Ploting the recovery rate distribution
ggplot(data=d[recovery_rate>0], aes(x=recovery_rate)) + geom_histogram(fill='steelblue', color='black')
```

## EAD independant variable - credit conversion factor

```{r credit conversion factor}
d[, CCF:=(funded_amnt - total_rec_prncp)/funded_amnt]
ggplot(data=d, aes(x=CCF)) + geom_histogram(fill='steelblue', color='black')
```

# Loans issued by month

```{r loan by month}
grouped = d[, .N, by="issue_d_formated"]
grouped = grouped[order(issue_d_formated)]
ggplot(data=grouped, aes(x=issue_d_formated, y=N)) + geom_line()
```