---
title: "Expected credit loss - explanatory data analysis"
author: "Eligijus Bujokas"
date: "12/19/2020"
output: 
  html_document:
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(data.table)
library(ggplot2)
library(zoo)
library(stringr)
library(gridExtra)
library(reshape)
Sys.setlocale("LC_ALL","C")
```

# Overview

This document is used to explore the data of the company called "LendingClub". It is an American company that provides short term loans both for individuals and for bussineses. 

To know more about the company, visit: https://www.lendingclub.com/ 

All the files and codes used in this project are stored in the repo: https://github.com/Eligijus112/expected-credit-loss 

The data can be found in kaggle: https://www.kaggle.com/denychaen/lending-club-loans-rejects-data

The data has information about all approved loans from 2007 up until 2019 3th quarter. 

# Reading the data 

```{r "Reading data"}
# Using fread to read the data
d <- fread('data/Loan_status_2007-2020Q3.gzip')

# Total number of loans in the data set
print(nrow(d))

# Total number of columns 
print(ncol(d))
```

In the dataset there are 150 features regarding a unique loan. We will analyze and use in models only some of the features:

**addr_state** - The state provided by the borrower in the loan application

**annual_inc** - The self-reported annual income provided by the borrower during registration.

**dti** - debt to income ratio; a ratio calculated using the borrower’s total monthly debt payments on the total debt obligations, excluding mortgage and the requested LC loan, divided by the borrower’s self-reported monthly income.

**emp_length** - Employment length in years. Possible values are between 0 and 10 where 0 means less than one year and 10 means ten or more years. 

**earliest_cr_line** - the month at which the earliest credit line was opened for the borrower.

**funded_amnt** - The total amount committed to that loan at that point in time.

**home_ownership** - The home ownership status provided by the borrower during registration or obtained from the credit report. Our values are: RENT, OWN, MORTGAGE, OTHER.

**loan_amnt** - The listed amount of the loan applied for by the borrower. If at some point in time, the credit department reduces the loan amount, then it will be reflected in this value.

**loan_status** - current status of the loan.

**pub_rec** - Number of derogatory public records.

**pub_rec_bankruptcies** - Number of public record bankruptcies

**purpose** - A category provided by the borrower for the loan request. 

**issue_d** - The date at which the loan was issued.

**term** - number of payments on the loan. Values can be either 36 or 60.

**int_rate** - interest rate on the loan.

**recoveries** - post charge off gross recovery.

**total_rec_prncp** - principal received to date.

```{r "Important columns"}
# Defining all the columns used in the analysis
cols_to_use = c(
  "addr_state",
  "annual_inc",
  'emp_length',
  'earliest_cr_line',
  'funded_amnt',
  'home_ownership',
  'loan_amnt',
  'loan_status',
  'pub_rec',
  'pub_rec_bankruptcies',
  'purpose',
  'issue_d',
  'term',
  'int_rate',
  'recoveries',
  'total_rec_prncp',
  'dti'
)

# Subseting the data
d <- d[, ..cols_to_use]

# Printing the top of the data table
head(d)
```
# Data cleaning and engineering

Before analyzing the various splits of the data there are some columns that need to be cleaned and engineered. 

## Date columns 

```{r dates}
# Creating the splited columns 
d[, c("issue_m", "issue_y"):=tstrsplit(issue_d, "-")]

# Getting the last two digits of issue_y
d[, issue_y:=str_sub(issue_y, -2)]

# Creating the formated column
d[, issue_d_formated:=zoo::as.yearmon(paste(issue_m, issue_y, sep="-"), "%b-%y")]

# Creating the splited columns 
d[, c("cr_m", "cr_y"):=tstrsplit(earliest_cr_line, "-")]

# Getting the last two digits of issue_y
d[, cr_y:=str_sub(cr_y, -2)]

# Wrangling the earliest cr column
d[, earliest_cr_line_formated:=zoo::as.yearmon(paste(cr_m, cr_y, sep="-"), "%b-%y")]

# Calculating the difference between the two dates
d[, day_diff:=difftime(issue_d_formated, earliest_cr_line_formated, units='days')]

# Converting to numeric
d[, day_diff:=as.numeric(day_diff)]

# Dropping negative or missing values from the dataframe; these are very old accounts and compise a fraction of percent of the whole data
d <- d[d$day_diff > 0 & !is.na(d$day_diff)]

# Calculating the month diff 
d[, month_diff:=round(day_diff/30)]
```

## Historic loan issues 

```{r loansbytime}
# Aggregating by issue date and sorting
loan_n = d[, .N, by="issue_d_formated"] %>% 
  .[order(issue_d_formated)] %>% 
  .[, issue_year:=year(issue_d_formated)] %>%
  .[, N_y:=sum(N), by='issue_year'] %>% 
  setnames(., c('N', 'N_y'), c('loans_monthly', 'loans_yearly'))

# Ploting the time series
p1 <- ggplot(data=loan_n, aes(x=issue_d_formated, y=loans_monthly)) + geom_bar(stat="identity", fill="steelblue", color='black') + ggtitle('Monthly count of issued loans')
p2 <- ggplot(data=unique(loan_n[, .(issue_year, loans_yearly)]), aes(x=issue_year, y=loans_yearly)) + geom_bar(stat="identity", fill="steelblue", color='black') + ggtitle('Yearly count of issued loans')

grid.arrange(p1, p2, ncol = 1)
```

## Creating the Y variable 

```{r y variable}
# Printing out unique loan statuses
print(unique(d$loan_status))

# Function to encode the good loans as 1 and 0 as bad loans
create_Y <- function(x, bad_loans=c('Late (31-120 days)', "Default", "Charged Off", "Does not meet the credit policy. Status:Charged Off")){
  return(ifelse(is.element(x, bad_loans), 'bad', 'good'))
}

# Creating the Y variable
d[, Y:=create_Y(loan_status)]

# Saving the variable as factor
d$Y <- as.factor(d$Y)

# Visualizing the di stribution of Y 
bymonth <- d[, .N, by=c("issue_d_formated", "Y")] %>% 
  cast(., issue_d_formated ~ Y, value="N") %>% 
  data.table(.) %>% 
  .[, rate:=bad * 100/(bad + good)]

# Calculating the shares
ggplot(data=bymonth, aes(x=issue_d_formated, y=rate)) + geom_area(color="darkblue", fill="lightblue")
```

After some investigation online and inspecting the drastic decrease in bad loan count since 2016, we will only keep the reliable data up until the end of 2016.

```{r subset}
d <- d[issue_d_formated < zoo::as.yearmon('2017-01')]
print(nrow(d))
```

## Summary statistics of numeric features

```{r summary}
# Cleaning the interest rates
d$int_rate <- as.numeric(gsub("%", "", d$int_rate))

summary(d[, c('annual_inc', 'loan_amnt', 'pub_rec', 'pub_rec_bankruptcies', 'int_rate', 'dti', 'month_diff')])
```


## Debt to income ratio

```{r dti}
ggplot(data=d[dti<100], aes(x=dti, fill=Y)) + geom_density(alpha=0.5)

# Droping the rows with negative dti 
d <- d[dti>=0]
```

## Annual income

```{r annual_income}
ggplot(data=d[annual_inc < 200000], aes(x=annual_inc, fill=Y)) + geom_density(alpha=0.5)
```

## Loan amount

```{r loan_amount}
ggplot(data=d, aes(x=loan_amnt, fill=Y)) + geom_density(alpha=0.5)
```

## Interest rate 

```{r interest rate}
ggplot(data=d, aes(x=int_rate, fill=Y)) + geom_density(alpha=0.5)
```

## Cleaninng the employment length variable

```{r emp length}
clean_emp_length <- function(x){
  return(ifelse(x=="", "< 1 year", x))
}

d[, emp_length:=clean_emp_length(emp_length)]
```

## LGD independant variable - recovery rate

```{r recovery rate, warning=FALSE}
d[, recovery_rate:=recoveries/funded_amnt]
d[, recovery_rate:=ifelse(recovery_rate>1, 1, recovery_rate)]

# Ploting the recovery rate distribution
p1 <- ggplot(data=d, aes(x=recovery_rate)) + geom_histogram(fill='steelblue', color='black') + ggtitle('Full data')

# Ploting the recovery rate distribution without the recovery rate of 0
p2 <- ggplot(data=d[recovery_rate>0], aes(x=recovery_rate)) + geom_histogram(fill='steelblue', color='black') + ggtitle('Without 0')

grid.arrange(p1, p2, nrow = 1)
```

## EAD independant variable - credit conversion factor

```{r credit conversion factor, warning=FALSE}
d[, CCF:=(funded_amnt - total_rec_prncp)/funded_amnt]

# Ploting the recovery rate distribution
p1 <- ggplot(data=d, aes(x=CCF)) + geom_histogram(fill='steelblue', color='black') + ggtitle('Full data')

# Ploting the recovery rate distribution without the recovery rate of 0
p2 <- ggplot(data=d[CCF>0], aes(x=CCF)) + geom_histogram(fill='steelblue', color='black') + ggtitle('Without 0')

grid.arrange(p1, p2, nrow = 1)
```

# Spliting the data into train and test sets

The objective of this analysis is to create an ECL model that uses data up to 2015 (train set) to create the model and then test it out on unseen data from 2016 (test set). We will save this data into two separate files - train.csv and test.csv.

```{r train_test_split}
final_cols = c(
  "issue_d",
  "term",
  "loan_amnt",
  "Y",
  "annual_inc",
  "emp_length",
  "pub_rec",
  "home_ownership",
  "pub_rec_bankruptcies",
  "purpose",
  "int_rate",
  "dti",
  "month_diff",
  "recovery_rate",
  "CCF"
)

train <- d[issue_d_formated < zoo::as.yearmon('2016-01'), ..final_cols]
test <- d[issue_d_formated >= zoo::as.yearmon('2016-01'), ..final_cols]

# Saving the data 
write.csv(na.omit(train), 'data/train.csv', row.names=FALSE)
write.csv(na.omit(test), 'data/test.csv', row.names=FALSE)
```

# Removing objects from memory

```{r}
rm(list=ls())
```


